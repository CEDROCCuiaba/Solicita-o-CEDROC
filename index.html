<script>
  async function gerarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'mm', format: 'a4' });

    const nome = document.getElementById('nomePaciente').value;
    const nascimento = document.getElementById('nascimentoPaciente').value;
    const telefonePaciente = document.getElementById('telefonePaciente').value;
    const dentista = document.getElementById('dentistaSolicitante').value;
    const cro = document.getElementById('croDentista').value;
    const telefoneDentista = document.getElementById('telefoneDentista').value;
    const exame = document.getElementById('exameRealizado').value;
    const motivo = document.getElementById('motivoSolicitacao').value;
    const dataHora = new Date().toLocaleString('pt-BR');

    const gerarDocumento = () => {
      doc.setDrawColor(100);
      doc.setLineWidth(0.5);
      doc.rect(10, 10, 190, 277);

      doc.setFontSize(14);
      doc.setFont("helvetica", "bold");
      doc.text("Requisição Online CEDROC", 105, 30, { align: "center" });

      doc.setFont("helvetica", "normal");
      doc.setFontSize(12);
      doc.text("Telefone: (65) 98402-5987", 105, 38, { align: "center" });

      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text(`Gerado em: ${dataHora}`, 180, 45, { align: "right" });
      doc.setTextColor(0);

      let y = 55;
      const espaco = 10;

      const dados = [
        { label: "Agendamento de Paciente", bold: true, skipLine: true },
        { label: "Nome:", valor: nome },
        { label: "Nascimento:", valor: nascimento },
        { label: "Telefone:", valor: telefonePaciente },
        { label: "Dentista Solicitante:", valor: dentista },
        { label: "CRO:", valor: cro },
        { label: "Telefone do Dentista:", valor: telefoneDentista },
        { label: "Exame a ser realizado:", valor: exame },
        { label: "Motivo da Solicitação:", valor: motivo }
      ];

      dados.forEach(item => {
        if (item.skipLine) {
          y += 5;
          doc.setFont("helvetica", "bold");
          doc.setFontSize(13);
          doc.text(item.label, 15, y);
          y += espaco;
        } else {
          doc.setFont("helvetica", "bold");
          doc.text(item.label, 15, y);
          doc.setFont("helvetica", "normal");
          doc.text(item.valor, 60, y);
          y += espaco;
        }
      });

      // QR code e mensagem
      const qr = new Image();
      qr.src = "https://chart.googleapis.com/chart?chs=100x100&cht=qr&chl=https://wa.me/5565984025987";
      qr.onload = function () {
        doc.setFontSize(10);
        doc.text("Fale conosco por WhatsApp:", 15, 250);
        doc.addImage(qr, "PNG", 15, 255, 30, 30);

        doc.setFont("helvetica", "bold");
        doc.setFontSize(11);
        const texto = "Nos mande essa requisição por WhatsApp e agende agora mesmo o seu exame.";
        const linhas = doc.splitTextToSize(texto, 110);
        doc.text(linhas, 50, 260);

        finalizarPDF();
      };

      qr.onerror = finalizarPDF; // continua mesmo se falhar
    };

    const logo = new Image();
    logo.src = "logo_cedroc.png";
    logo.onload = function () {
      doc.addImage(logo, 'PNG', 85, 10, 40, 40);
      gerarDocumento();
    };
    logo.onerror = gerarDocumento;

    function finalizarPDF() {
      const blob = doc.output("blob");
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `solicitacao_${nome.replace(/\s+/g, "_")}.pdf`;
      a.click();
    }
  }
</script>
